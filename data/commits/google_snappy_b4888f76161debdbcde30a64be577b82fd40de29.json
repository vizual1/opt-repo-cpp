{
  "metadata": {
    "collection_date": "2026-02-03T20:02:09.317731",
    "repository": "https://github.com/google/snappy",
    "repository_name": "google/snappy"
  },
  "commit_info": {
    "old_sha": "b3fb0b5b4b076f1af12f5c727b33e0abf723fe12",
    "new_sha": "b4888f76161debdbcde30a64be577b82fd40de29",
    "commit_message": [
      "Optimize tag extraction for ARM with conditional increment instruction generation (csinc). For codegen see https://gcc.godbolt.org/z/a8z9j95Pv\n\nPiperOrigin-RevId: 382688740"
    ],
    "commit_date": "2021-07-02T07:52:56+00:00",
    "patch": [
      "--- snappy.cc\n@@ -1004,7 +1004,26 @@ void MemMove(ptrdiff_t dst, const void* src, size_t size) {\n }\n \n SNAPPY_ATTRIBUTE_ALWAYS_INLINE\n-size_t AdvanceToNextTag(const uint8_t** ip_p, size_t* tag) {\n+size_t AdvanceToNextTagARMOptimized(const uint8_t** ip_p, size_t* tag) {\n+  const uint8_t*& ip = *ip_p;\n+  // This section is crucial for the throughput of the decompression loop.\n+  // The latency of an iteration is fundamentally constrained by the\n+  // following data chain on ip.\n+  // ip -> c = Load(ip) -> delta1 = (c & 3)        -> ip += delta1 or delta2\n+  //                       delta2 = ((c >> 2) + 1)    ip++\n+  // This is different from X86 optimizations because ARM has conditional add\n+  // instruction (csinc) and it removes several register moves.\n+  const size_t literal_tag_offset = (*tag >> 2) + 1;\n+  const size_t tag_type = *tag & 3;\n+  const bool is_literal = (tag_type == 0);\n+  *tag = is_literal ? ip[literal_tag_offset] : ip[tag_type];\n+  ip += is_literal ? literal_tag_offset : tag_type;\n+  ip++;\n+  return tag_type;\n+}\n+\n+SNAPPY_ATTRIBUTE_ALWAYS_INLINE\n+size_t AdvanceToNextTagX86Optimized(const uint8_t** ip_p, size_t* tag) {\n   const uint8_t*& ip = *ip_p;\n   // This section is crucial for the throughput of the decompression loop.\n   // The latency of an iteration is fundamentally constrained by the\n@@ -1084,7 +1103,11 @@ std::pair<const uint8_t*, ptrdiff_t> DecompressBranchless(\n         // For literals tag_type = 0, hence we will always obtain 0 from\n         // ExtractLowBytes. For literals offset will thus be kLiteralOffset.\n         ptrdiff_t len_min_offset = table.length_minus_offset[tag];\n-        size_t tag_type = AdvanceToNextTag(&ip, &tag);\n+#if defined(__aarch64__)\n+        size_t tag_type = AdvanceToNextTagARMOptimized(&ip, &tag);\n+#else\n+        size_t tag_type = AdvanceToNextTagX86Optimized(&ip, &tag);\n+#endif\n         uint32_t next = LittleEndian::Load32(old_ip);\n         size_t len = len_min_offset & 0xFF;\n         len_min_offset -= ExtractOffset(next, tag_type);"
    ],
    "files_changed": [
      {
        "filename": "snappy.cc",
        "status": "modified",
        "additions": 25,
        "deletions": 2,
        "changes": 27,
        "patch": "@@ -1004,7 +1004,26 @@ void MemMove(ptrdiff_t dst, const void* src, size_t size) {\n }\n \n SNAPPY_ATTRIBUTE_ALWAYS_INLINE\n-size_t AdvanceToNextTag(const uint8_t** ip_p, size_t* tag) {\n+size_t AdvanceToNextTagARMOptimized(const uint8_t** ip_p, size_t* tag) {\n+  const uint8_t*& ip = *ip_p;\n+  // This section is crucial for the throughput of the decompression loop.\n+  // The latency of an iteration is fundamentally constrained by the\n+  // following data chain on ip.\n+  // ip -> c = Load(ip) -> delta1 = (c & 3)        -> ip += delta1 or delta2\n+  //                       delta2 = ((c >> 2) + 1)    ip++\n+  // This is different from X86 optimizations because ARM has conditional add\n+  // instruction (csinc) and it removes several register moves.\n+  const size_t literal_tag_offset = (*tag >> 2) + 1;\n+  const size_t tag_type = *tag & 3;\n+  const bool is_literal = (tag_type == 0);\n+  *tag = is_literal ? ip[literal_tag_offset] : ip[tag_type];\n+  ip += is_literal ? literal_tag_offset : tag_type;\n+  ip++;\n+  return tag_type;\n+}\n+\n+SNAPPY_ATTRIBUTE_ALWAYS_INLINE\n+size_t AdvanceToNextTagX86Optimized(const uint8_t** ip_p, size_t* tag) {\n   const uint8_t*& ip = *ip_p;\n   // This section is crucial for the throughput of the decompression loop.\n   // The latency of an iteration is fundamentally constrained by the\n@@ -1084,7 +1103,11 @@ std::pair<const uint8_t*, ptrdiff_t> DecompressBranchless(\n         // For literals tag_type = 0, hence we will always obtain 0 from\n         // ExtractLowBytes. For literals offset will thus be kLiteralOffset.\n         ptrdiff_t len_min_offset = table.length_minus_offset[tag];\n-        size_t tag_type = AdvanceToNextTag(&ip, &tag);\n+#if defined(__aarch64__)\n+        size_t tag_type = AdvanceToNextTagARMOptimized(&ip, &tag);\n+#else\n+        size_t tag_type = AdvanceToNextTagX86Optimized(&ip, &tag);\n+#endif\n         uint32_t next = LittleEndian::Load32(old_ip);\n         size_t len = len_min_offset & 0xFF;\n         len_min_offset -= ExtractOffset(next, tag_type);"
      }
    ],
    "lines_added": 25,
    "lines_removed": 2
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": [
      "apt-get update",
      "cmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DSNAPPY_BUILD_TESTS=ON -DBENCHMARK_ENABLE_TESTING=ON",
      "cmake --build /test_workspace/workspace/old/build -- -j 1"
    ],
    "new_build_script": [
      "apt-get update",
      "cmake -S /test_workspace/workspace/new -B /test_workspace/workspace/new/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DSNAPPY_BUILD_TESTS=ON -DBENCHMARK_ENABLE_TESTING=ON",
      "cmake --build /test_workspace/workspace/new/build -- -j 1"
    ],
    "old_test_script": [
      "cd /test_workspace/workspace/old/build",
      "ctest --output-on-failure"
    ],
    "new_test_script": [
      "cd /test_workspace/workspace/new/build",
      "ctest --output-on-failure"
    ],
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 1.0,
    "is_pair_significant": false,
    "pair_p_value": 1.0,
    "is_binom_significant": false,
    "binom_p_value": 1.0,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.9999991543985346,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.7140239309466256,
    "relative_improvement": -0.0012956164975165795,
    "absolute_improvement_ms": -12.000000000000455,
    "old_mean_ms": 9262.0,
    "new_mean_ms": 9274.0,
    "old_std_ms": 43.023650272362985,
    "new_std_ms": 55.99261034987654,
    "effect_size_cohens_d": -0.24033172095998834,
    "old_ci95_ms": [
      9245.934704962567,
      9278.065295037435
    ],
    "new_ci95_ms": [
      9253.092015682252,
      9294.90798431775
    ],
    "old_ci99_ms": [
      9240.348566895738,
      9283.651433104262
    ],
    "new_ci99_ms": [
      9245.822003720077,
      9302.177996279925
    ],
    "new_times_s": [
      9.29,
      9.23,
      9.25,
      9.24,
      9.28,
      9.25,
      9.23,
      9.27,
      9.41,
      9.25,
      9.25,
      9.25,
      9.27,
      9.28,
      9.3,
      9.26,
      9.28,
      9.27,
      9.18,
      9.28,
      9.29,
      9.28,
      9.29,
      9.3,
      9.28,
      9.18,
      9.31,
      9.18,
      9.32,
      9.31,
      9.45
    ],
    "old_times_s": [
      9.21,
      9.22,
      9.24,
      9.22,
      9.23,
      9.27,
      9.29,
      9.2,
      9.14,
      9.26,
      9.25,
      9.25,
      9.29,
      9.26,
      9.3,
      9.25,
      9.29,
      9.29,
      9.28,
      9.32,
      9.25,
      9.27,
      9.29,
      9.28,
      9.29,
      9.17,
      9.27,
      9.29,
      9.27,
      9.27,
      9.36
    ]
  },
  "tests": {
    "total_tests": 1,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 0,
    "significant_mannwhitney_regressions_tests": [],
    "tests": [
      {
        "test_name": "snappy_unittest",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999981485789979,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.726329749971054,
        "relative_improvement": -0.0013880855986119671,
        "absolute_improvement_ms": -12.857142857141568,
        "old_mean_ms": 9262.500000000002,
        "new_mean_ms": 9275.357142857143,
        "old_std_ms": 44.77309046324152,
        "new_std_ms": 57.12119298325874,
        "effect_size_cohens_d": -0.250529476546283,
        "old_ci95_ms": [
          9245.138807936064,
          9279.861192063938
        ],
        "new_ci95_ms": [
          9253.207856487961,
          9297.506429226323
        ],
        "old_ci99_ms": [
          9239.05636828651,
          9285.943631713491
        ],
        "new_ci99_ms": [
          9245.44792288864,
          9305.266362825647
        ],
        "new_times": [
          9.24,
          9.28,
          9.25,
          9.23,
          9.27,
          9.41,
          9.24,
          9.25,
          9.25,
          9.27,
          9.28,
          9.3,
          9.26,
          9.28,
          9.27,
          9.18,
          9.27,
          9.29,
          9.28,
          9.29,
          9.3,
          9.28,
          9.18,
          9.31,
          9.18,
          9.31,
          9.31,
          9.45
        ],
        "old_times": [
          9.22,
          9.23,
          9.27,
          9.28,
          9.19,
          9.14,
          9.26,
          9.24,
          9.25,
          9.29,
          9.26,
          9.3,
          9.25,
          9.28,
          9.29,
          9.28,
          9.32,
          9.25,
          9.27,
          9.29,
          9.28,
          9.29,
          9.16,
          9.27,
          9.29,
          9.27,
          9.27,
          9.36
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}