{
  "metadata": {
    "collection_date": "2026-01-11T17:52:53.256607",
    "repository": "https://github.com/projectM-visualizer/projectm",
    "repository_name": "projectM-visualizer/projectm"
  },
  "commit_info": {
    "old_sha": "561ea8cf8b9979636c1fbfe6f20fba5d12ed87dc",
    "new_sha": "c266599933ee5a9755b055b10cd3a463f8413158",
    "commit_message": [
      "Instead of color masking, attach/detach the motion vector u/v texture.\n\nOnly GLES 3.2 supports glColorMaski, which would exclude any platforms only supporting GLES 3.0 or 3.1, so we simply change the color attachment accordingly. This change also improves VRAM usage, as now there's only a single u/v texture used for both framebuffers as required."
    ],
    "commit_date": "2023-09-09T13:47:32+00:00",
    "patch": [
      "--- src/libprojectM/MilkdropPreset/MilkdropPreset.cpp\n@@ -76,14 +76,14 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     m_state.audioData = audioData;\n     m_state.renderContext = renderContext;\n \n-    // Update framebuffer size if needed\n+    // Update framebuffer and u/v texture size if needed\n     if (m_framebuffer.SetSize(renderContext.viewportSizeX, renderContext.viewportSizeY))\n     {\n+        m_motionVectorUVMap->SetSize(renderContext.viewportSizeX, renderContext.viewportSizeY);\n         m_isFirstFrame = true;\n     }\n \n     m_state.mainTexture = m_framebuffer.GetColorAttachmentTexture(m_previousFrameBuffer, 0);\n-    m_framebuffer.MaskDrawBuffer(1, true);\n \n     // First evaluate per-frame code\n     PerFrameUpdate();\n@@ -95,20 +95,21 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     // Only do it after drawing one frame after init or resize.\n     if (!m_isFirstFrame)\n     {\n-        m_motionVectors.Draw(m_perFrameContext, m_framebuffer.GetColorAttachmentTexture(m_previousFrameBuffer, 1));\n+        m_motionVectors.Draw(m_perFrameContext, m_motionVectorUVMap->Texture());\n     }\n \n     // We now draw to the first framebuffer, but read from the second one for warping and textured shapes.\n     m_framebuffer.BindRead(m_previousFrameBuffer);\n     m_framebuffer.BindDraw(m_currentFrameBuffer);\n \n-    // Unmask the motion vector u/v texture for the warp mesh draw and clean both buffers.\n-    m_framebuffer.MaskDrawBuffer(1, false);\n+    // Add motion vector u/v texture for the warp mesh draw and clean both buffers.\n+    m_framebuffer.SetAttachment(m_currentFrameBuffer, 1, m_motionVectorUVMap);\n \n     // Draw previous frame image warped via per-pixel mesh and warp shader\n     m_perPixelMesh.Draw(m_state, m_perFrameContext, m_perPixelContext);\n \n-    m_framebuffer.MaskDrawBuffer(1, true);\n+    // Remove the u/v texture from the framebuffer.\n+    m_framebuffer.RemoveColorAttachment(m_currentFrameBuffer, 1);\n \n     // Update blur textures\n     m_state.blurTexture.Update(m_state, m_perFrameContext);\n@@ -148,7 +149,7 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     glReadBuffer(GL_COLOR_ATTACHMENT0);\n #if USE_GLES\n     {\n-        GLenum drawBuffers[] = { GL_BACK };\n+        GLenum drawBuffers[] = {GL_BACK};\n         glDrawBuffers(1, drawBuffers);\n     }\n #else\n@@ -162,9 +163,6 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     std::swap(m_currentFrameBuffer, m_previousFrameBuffer);\n \n     m_isFirstFrame = false;\n-\n-    // Reset color mask state for attachment 1\n-    m_framebuffer.MaskDrawBuffer(1, false);\n }\n \n \n@@ -225,13 +223,9 @@ void MilkdropPreset::Load(std::istream& stream)\n void MilkdropPreset::InitializePreset(PresetFileParser& parsedFile)\n {\n     // Create the offscreen rendering surfaces.\n-    m_framebuffer.CreateColorAttachment(0, 0);                            // Main image\n-    m_framebuffer.CreateColorAttachment(0, 1, GL_RG16F, GL_RG, GL_FLOAT); // Motion vector u/v\n-    m_framebuffer.CreateColorAttachment(1, 0);                            // Main image\n-    m_framebuffer.CreateColorAttachment(1, 1, GL_RG16F, GL_RG, GL_FLOAT); // Motion vector u/v\n-\n-    // Mask the motion vector buffer by default.\n-    m_framebuffer.MaskDrawBuffer(1, true);\n+    m_motionVectorUVMap = std::make_shared<TextureAttachment>(GL_RG16F, GL_RG, GL_FLOAT, 0, 0);\n+    m_framebuffer.CreateColorAttachment(0, 0); // Main image 1\n+    m_framebuffer.CreateColorAttachment(1, 0); // Main image 2\n \n     Framebuffer::Unbind();\n \n--- src/libprojectM/MilkdropPreset/MilkdropPreset.hpp\n@@ -99,9 +99,10 @@ class MilkdropPreset : public Preset\n     std::string m_absoluteFilePath; //!< The absolute file path of the MilkdropPreset\n     std::string m_absolutePath;     //!< The absolute path of the MilkdropPreset\n \n-    Framebuffer m_framebuffer{2}; //!< Preset rendering framebuffer with two surfaces (last frame and current frame).\n-    int m_currentFrameBuffer{0};  //!< Framebuffer ID of the current frame.\n-    int m_previousFrameBuffer{1}; //!< Framebuffer ID of the previous frame.\n+    Framebuffer m_framebuffer{2};                           //!< Preset rendering framebuffer with two surfaces (last frame and current frame).\n+    int m_currentFrameBuffer{0};                            //!< Framebuffer ID of the current frame.\n+    int m_previousFrameBuffer{1};                           //!< Framebuffer ID of the previous frame.\n+    std::shared_ptr<TextureAttachment> m_motionVectorUVMap; //!< The UV map of the previous frame's warp mesh, used for motion vector reverse propagation.\n \n     PresetState m_state;               //!< Preset state container.\n     PerFrameContext m_perFrameContext; //!< Preset per-frame evaluation code context."
    ],
    "files_changed": [
      {
        "filename": "src/libprojectM/MilkdropPreset/MilkdropPreset.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 17,
        "changes": 28,
        "patch": "@@ -76,14 +76,14 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     m_state.audioData = audioData;\n     m_state.renderContext = renderContext;\n \n-    // Update framebuffer size if needed\n+    // Update framebuffer and u/v texture size if needed\n     if (m_framebuffer.SetSize(renderContext.viewportSizeX, renderContext.viewportSizeY))\n     {\n+        m_motionVectorUVMap->SetSize(renderContext.viewportSizeX, renderContext.viewportSizeY);\n         m_isFirstFrame = true;\n     }\n \n     m_state.mainTexture = m_framebuffer.GetColorAttachmentTexture(m_previousFrameBuffer, 0);\n-    m_framebuffer.MaskDrawBuffer(1, true);\n \n     // First evaluate per-frame code\n     PerFrameUpdate();\n@@ -95,20 +95,21 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     // Only do it after drawing one frame after init or resize.\n     if (!m_isFirstFrame)\n     {\n-        m_motionVectors.Draw(m_perFrameContext, m_framebuffer.GetColorAttachmentTexture(m_previousFrameBuffer, 1));\n+        m_motionVectors.Draw(m_perFrameContext, m_motionVectorUVMap->Texture());\n     }\n \n     // We now draw to the first framebuffer, but read from the second one for warping and textured shapes.\n     m_framebuffer.BindRead(m_previousFrameBuffer);\n     m_framebuffer.BindDraw(m_currentFrameBuffer);\n \n-    // Unmask the motion vector u/v texture for the warp mesh draw and clean both buffers.\n-    m_framebuffer.MaskDrawBuffer(1, false);\n+    // Add motion vector u/v texture for the warp mesh draw and clean both buffers.\n+    m_framebuffer.SetAttachment(m_currentFrameBuffer, 1, m_motionVectorUVMap);\n \n     // Draw previous frame image warped via per-pixel mesh and warp shader\n     m_perPixelMesh.Draw(m_state, m_perFrameContext, m_perPixelContext);\n \n-    m_framebuffer.MaskDrawBuffer(1, true);\n+    // Remove the u/v texture from the framebuffer.\n+    m_framebuffer.RemoveColorAttachment(m_currentFrameBuffer, 1);\n \n     // Update blur textures\n     m_state.blurTexture.Update(m_state, m_perFrameContext);\n@@ -148,7 +149,7 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     glReadBuffer(GL_COLOR_ATTACHMENT0);\n #if USE_GLES\n     {\n-        GLenum drawBuffers[] = { GL_BACK };\n+        GLenum drawBuffers[] = {GL_BACK};\n         glDrawBuffers(1, drawBuffers);\n     }\n #else\n@@ -162,9 +163,6 @@ void MilkdropPreset::RenderFrame(const libprojectM::Audio::FrameAudioData& audio\n     std::swap(m_currentFrameBuffer, m_previousFrameBuffer);\n \n     m_isFirstFrame = false;\n-\n-    // Reset color mask state for attachment 1\n-    m_framebuffer.MaskDrawBuffer(1, false);\n }\n \n \n@@ -225,13 +223,9 @@ void MilkdropPreset::Load(std::istream& stream)\n void MilkdropPreset::InitializePreset(PresetFileParser& parsedFile)\n {\n     // Create the offscreen rendering surfaces.\n-    m_framebuffer.CreateColorAttachment(0, 0);                            // Main image\n-    m_framebuffer.CreateColorAttachment(0, 1, GL_RG16F, GL_RG, GL_FLOAT); // Motion vector u/v\n-    m_framebuffer.CreateColorAttachment(1, 0);                            // Main image\n-    m_framebuffer.CreateColorAttachment(1, 1, GL_RG16F, GL_RG, GL_FLOAT); // Motion vector u/v\n-\n-    // Mask the motion vector buffer by default.\n-    m_framebuffer.MaskDrawBuffer(1, true);\n+    m_motionVectorUVMap = std::make_shared<TextureAttachment>(GL_RG16F, GL_RG, GL_FLOAT, 0, 0);\n+    m_framebuffer.CreateColorAttachment(0, 0); // Main image 1\n+    m_framebuffer.CreateColorAttachment(1, 0); // Main image 2\n \n     Framebuffer::Unbind();\n "
      },
      {
        "filename": "src/libprojectM/MilkdropPreset/MilkdropPreset.hpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "patch": "@@ -99,9 +99,10 @@ class MilkdropPreset : public Preset\n     std::string m_absoluteFilePath; //!< The absolute file path of the MilkdropPreset\n     std::string m_absolutePath;     //!< The absolute path of the MilkdropPreset\n \n-    Framebuffer m_framebuffer{2}; //!< Preset rendering framebuffer with two surfaces (last frame and current frame).\n-    int m_currentFrameBuffer{0};  //!< Framebuffer ID of the current frame.\n-    int m_previousFrameBuffer{1}; //!< Framebuffer ID of the previous frame.\n+    Framebuffer m_framebuffer{2};                           //!< Preset rendering framebuffer with two surfaces (last frame and current frame).\n+    int m_currentFrameBuffer{0};                            //!< Framebuffer ID of the current frame.\n+    int m_previousFrameBuffer{1};                           //!< Framebuffer ID of the previous frame.\n+    std::shared_ptr<TextureAttachment> m_motionVectorUVMap; //!< The UV map of the previous frame's warp mesh, used for motion vector reverse propagation.\n \n     PresetState m_state;               //!< Preset state container.\n     PerFrameContext m_perFrameContext; //!< Preset per-frame evaluation code context."
      }
    ],
    "lines_added": 15,
    "lines_removed": 20
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_TESTING=ON -DENABLE_TESTING=ON",
    "new_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_TESTING=ON -DENABLE_TESTING=ON",
    "old_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "new_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 0.7164526406595224,
    "is_pair_significant": false,
    "pair_p_value": 0.706734557413923,
    "is_binom_significant": false,
    "binom_p_value": 0.9999999990686774,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.999998699808437,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.16685534787178302,
    "relative_improvement": 0.03225806451612906,
    "absolute_improvement_ms": 0.33333333333333304,
    "old_mean_ms": 10.333333333333336,
    "new_mean_ms": 10.000000000000002,
    "old_std_ms": 1.8257418583505538,
    "new_std_ms": 1.7643790169011568e-15,
    "effect_size_cohens_d": 0.2581988897471609,
    "old_ci95_ms": [
      9.651590119289102,
      11.01507654737757
    ],
    "new_ci95_ms": [
      10.000000000000002,
      10.000000000000002
    ],
    "old_ci99_ms": [
      9.41453803210989,
      11.252128634556781
    ],
    "new_ci99_ms": [
      10.0,
      10.000000000000004
    ],
    "new_times_s": [
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01
    ],
    "old_times_s": [
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.02,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01,
      0.01
    ]
  },
  "tests": {
    "total_tests": 1,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 0,
    "significant_mannwhitney_regressions_tests": [],
    "tests": [
      {
        "test_name": "projectM-unittest",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999999638108507,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 1.0,
        "relative_improvement": 0.0,
        "absolute_improvement_ms": 0.0,
        "old_mean_ms": 10.000000000000002,
        "new_mean_ms": 10.000000000000002,
        "old_std_ms": 1.7654289301252243e-15,
        "new_std_ms": 1.7654289301252243e-15,
        "effect_size_cohens_d": 0.0,
        "old_ci95_ms": [
          10.000000000000002,
          10.000000000000002
        ],
        "new_ci95_ms": [
          10.000000000000002,
          10.000000000000002
        ],
        "old_ci99_ms": [
          10.0,
          10.000000000000004
        ],
        "new_ci99_ms": [
          10.0,
          10.000000000000004
        ],
        "new_times": [
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01
        ],
        "old_times": [
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01,
          0.01
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}