{
  "metadata": {
    "collection_date": "2026-01-14T18:38:08.998707",
    "repository": "https://github.com/quick-lint/quick-lint-js",
    "repository_name": "quick-lint/quick-lint-js"
  },
  "commit_info": {
    "old_sha": "c4291b71275fa491ba59ace69a7e16bdfd1e19ea",
    "new_sha": "7b11341514a046674af49fa1db892fea7fe76fd6",
    "commit_message": [
      "Fix quadratic time and space when parsing 'await/'\n\nPathalogical code can cause quick-lint-js to consume tons of memory and\ntons of time. The root cause is infinite lookahead (implemented as backtracking) which occurs when parsing code like the following:\n\n    function f() {\n      await/\n      ()=>{{{{{{{await/\n      ()=>{{{{{{{await/\n      ()=>{{{{{{{await/\n      ()=>{{{{{{{await/\n      ()=>{{{{{{{await/\n    }\n\nquick-lint-js' algorithm for determining whether 'await' is supposed to\nbe an identifier or an operator parses what follows speculatively.\nBecause the speculative parse can parse an arbitrary amount of code,\nand speculative parses can be nested, we end up with quadratic behavior.\n\nCache 'await' guesses to turn the quadratic behavior into linear\nbehavior.\n\nThis code should improve performance for pathalogical cases without\nchanging behavior."
    ],
    "commit_date": "2021-10-12T01:30:20+00:00",
    "patch": [
      "--- src/parse.cpp\n@@ -711,6 +711,21 @@ expression* parser::parse_await_expression(token await_token, precedence prec) {\n       // await / rhs;\n       case token_type::slash:\n       case token_type::slash_equal: {\n+        parse_expression_cache_key cache_key = {\n+            .begin = this->peek().begin,\n+            .in_top_level = this->in_top_level_,\n+            .in_async_function = this->in_async_function_,\n+            .in_generator_function = this->in_generator_function_,\n+            .in_loop_statement = this->in_loop_statement_,\n+            .in_switch_statement = this->in_switch_statement_,\n+            .in_class = this->in_class_,\n+        };\n+        auto cache_it =\n+            this->await_slash_is_identifier_divide_cache_.find(cache_key);\n+        if (cache_it != this->await_slash_is_identifier_divide_cache_.end()) {\n+          return cache_it->second;\n+        }\n+\n         buffering_error_reporter temp_error_reporter(&this->temporary_memory_);\n         error_reporter* old_error_reporter =\n             std::exchange(this->error_reporter_, &temp_error_reporter);\n@@ -732,13 +747,19 @@ expression* parser::parse_await_expression(token await_token, precedence prec) {\n         this->lexer_.roll_back_transaction(std::move(transaction));\n         this->error_reporter_ = old_error_reporter;\n \n+        bool is_identifier_result;\n         if (this->in_top_level_) {\n           bool parsed_slash_as_regexp = parsed_ok;\n-          return !parsed_slash_as_regexp;\n+          is_identifier_result = !parsed_slash_as_regexp;\n         } else {\n           bool parsed_slash_as_divide = parsed_ok;\n-          return parsed_slash_as_divide;\n+          is_identifier_result = parsed_slash_as_divide;\n         }\n+        auto [_cache_it, inserted] =\n+            this->await_slash_is_identifier_divide_cache_.try_emplace(\n+                cache_key, is_identifier_result);\n+        QLJS_ASSERT(inserted);\n+        return is_identifier_result;\n       }\n \n       case token_type::kw_of:\n@@ -2275,6 +2296,26 @@ parser::function_guard::~function_guard() noexcept {\n   this->parser_->in_loop_statement_ = this->was_in_loop_statement_;\n   this->parser_->in_switch_statement_ = this->was_in_switch_statement_;\n }\n+\n+bool parser::parse_expression_cache_key::operator==(\n+    const parser::parse_expression_cache_key& rhs) const noexcept {\n+  return this->begin == rhs.begin && this->in_top_level == rhs.in_top_level &&\n+         this->in_async_function == rhs.in_async_function &&\n+         this->in_generator_function == rhs.in_generator_function &&\n+         this->in_loop_statement == rhs.in_loop_statement &&\n+         this->in_switch_statement == rhs.in_switch_statement &&\n+         this->in_class == rhs.in_class;\n+}\n+\n+bool parser::parse_expression_cache_key::operator!=(\n+    const parser::parse_expression_cache_key& rhs) const noexcept {\n+  return !(*this == rhs);\n+}\n+\n+std::size_t parser::parse_expression_cache_key::hash::operator()(\n+    const parse_expression_cache_key& x) const noexcept {\n+  return std::hash<const char8*>()(x.begin);\n+}\n }\n \n // quick-lint-js finds bugs in JavaScript programs.\n--- src/quick-lint-js/parse.h\n@@ -21,6 +21,7 @@\n #include <quick-lint-js/parse-visitor.h>\n #include <quick-lint-js/token.h>\n #include <quick-lint-js/warning.h>\n+#include <unordered_map>\n #include <utility>\n \n #if QLJS_HAVE_SETJMP\n@@ -3712,6 +3713,23 @@ class parser {\n     int old_depth_;\n   };\n \n+  struct parse_expression_cache_key {\n+    const char8 *begin;\n+    bool in_top_level;\n+    bool in_async_function;\n+    bool in_generator_function;\n+    bool in_loop_statement;\n+    bool in_switch_statement;\n+    bool in_class;\n+\n+    bool operator==(const parse_expression_cache_key &rhs) const noexcept;\n+    bool operator!=(const parse_expression_cache_key &rhs) const noexcept;\n+\n+    struct hash {\n+      std::size_t operator()(const parse_expression_cache_key &) const noexcept;\n+    };\n+  };\n+\n   quick_lint_js::lexer lexer_;\n   error_reporter *error_reporter_;\n   quick_lint_js::expression_arena expressions_;\n@@ -3730,6 +3748,23 @@ class parser {\n   bool in_switch_statement_ = false;\n   bool in_class_ = false;\n \n+  // Cache of whether 'await' is an identifier or an operator. This cache is\n+  // used to avoid quadratic run-time in code like the following:\n+  //\n+  //   await / await / await / await / await\n+  //\n+  // (In `await/await`, `await` is an identifier. But in `await/await/`, the\n+  // first `await` is an operator.)\n+  //\n+  // The value of each entry indicates the conclusion:\n+  // * true means 'await' looks like an identifier, thus '/' is the division\n+  //   operator.\n+  // * false means 'await' looks like an operator, thus '/' begins a regular\n+  //   expression literal.\n+  std::unordered_map<parse_expression_cache_key, bool,\n+                     parse_expression_cache_key::hash>\n+      await_slash_is_identifier_divide_cache_;\n+\n #if QLJS_HAVE_SETJMP\n   bool have_fatal_parse_error_jmp_buf_ = false;\n   std::jmp_buf fatal_parse_error_jmp_buf_;"
    ],
    "files_changed": [
      {
        "filename": "src/parse.cpp",
        "status": "modified",
        "additions": 43,
        "deletions": 2,
        "changes": 45,
        "patch": "@@ -711,6 +711,21 @@ expression* parser::parse_await_expression(token await_token, precedence prec) {\n       // await / rhs;\n       case token_type::slash:\n       case token_type::slash_equal: {\n+        parse_expression_cache_key cache_key = {\n+            .begin = this->peek().begin,\n+            .in_top_level = this->in_top_level_,\n+            .in_async_function = this->in_async_function_,\n+            .in_generator_function = this->in_generator_function_,\n+            .in_loop_statement = this->in_loop_statement_,\n+            .in_switch_statement = this->in_switch_statement_,\n+            .in_class = this->in_class_,\n+        };\n+        auto cache_it =\n+            this->await_slash_is_identifier_divide_cache_.find(cache_key);\n+        if (cache_it != this->await_slash_is_identifier_divide_cache_.end()) {\n+          return cache_it->second;\n+        }\n+\n         buffering_error_reporter temp_error_reporter(&this->temporary_memory_);\n         error_reporter* old_error_reporter =\n             std::exchange(this->error_reporter_, &temp_error_reporter);\n@@ -732,13 +747,19 @@ expression* parser::parse_await_expression(token await_token, precedence prec) {\n         this->lexer_.roll_back_transaction(std::move(transaction));\n         this->error_reporter_ = old_error_reporter;\n \n+        bool is_identifier_result;\n         if (this->in_top_level_) {\n           bool parsed_slash_as_regexp = parsed_ok;\n-          return !parsed_slash_as_regexp;\n+          is_identifier_result = !parsed_slash_as_regexp;\n         } else {\n           bool parsed_slash_as_divide = parsed_ok;\n-          return parsed_slash_as_divide;\n+          is_identifier_result = parsed_slash_as_divide;\n         }\n+        auto [_cache_it, inserted] =\n+            this->await_slash_is_identifier_divide_cache_.try_emplace(\n+                cache_key, is_identifier_result);\n+        QLJS_ASSERT(inserted);\n+        return is_identifier_result;\n       }\n \n       case token_type::kw_of:\n@@ -2275,6 +2296,26 @@ parser::function_guard::~function_guard() noexcept {\n   this->parser_->in_loop_statement_ = this->was_in_loop_statement_;\n   this->parser_->in_switch_statement_ = this->was_in_switch_statement_;\n }\n+\n+bool parser::parse_expression_cache_key::operator==(\n+    const parser::parse_expression_cache_key& rhs) const noexcept {\n+  return this->begin == rhs.begin && this->in_top_level == rhs.in_top_level &&\n+         this->in_async_function == rhs.in_async_function &&\n+         this->in_generator_function == rhs.in_generator_function &&\n+         this->in_loop_statement == rhs.in_loop_statement &&\n+         this->in_switch_statement == rhs.in_switch_statement &&\n+         this->in_class == rhs.in_class;\n+}\n+\n+bool parser::parse_expression_cache_key::operator!=(\n+    const parser::parse_expression_cache_key& rhs) const noexcept {\n+  return !(*this == rhs);\n+}\n+\n+std::size_t parser::parse_expression_cache_key::hash::operator()(\n+    const parse_expression_cache_key& x) const noexcept {\n+  return std::hash<const char8*>()(x.begin);\n+}\n }\n \n // quick-lint-js finds bugs in JavaScript programs."
      },
      {
        "filename": "src/quick-lint-js/parse.h",
        "status": "modified",
        "additions": 35,
        "deletions": 0,
        "changes": 35,
        "patch": "@@ -21,6 +21,7 @@\n #include <quick-lint-js/parse-visitor.h>\n #include <quick-lint-js/token.h>\n #include <quick-lint-js/warning.h>\n+#include <unordered_map>\n #include <utility>\n \n #if QLJS_HAVE_SETJMP\n@@ -3712,6 +3713,23 @@ class parser {\n     int old_depth_;\n   };\n \n+  struct parse_expression_cache_key {\n+    const char8 *begin;\n+    bool in_top_level;\n+    bool in_async_function;\n+    bool in_generator_function;\n+    bool in_loop_statement;\n+    bool in_switch_statement;\n+    bool in_class;\n+\n+    bool operator==(const parse_expression_cache_key &rhs) const noexcept;\n+    bool operator!=(const parse_expression_cache_key &rhs) const noexcept;\n+\n+    struct hash {\n+      std::size_t operator()(const parse_expression_cache_key &) const noexcept;\n+    };\n+  };\n+\n   quick_lint_js::lexer lexer_;\n   error_reporter *error_reporter_;\n   quick_lint_js::expression_arena expressions_;\n@@ -3730,6 +3748,23 @@ class parser {\n   bool in_switch_statement_ = false;\n   bool in_class_ = false;\n \n+  // Cache of whether 'await' is an identifier or an operator. This cache is\n+  // used to avoid quadratic run-time in code like the following:\n+  //\n+  //   await / await / await / await / await\n+  //\n+  // (In `await/await`, `await` is an identifier. But in `await/await/`, the\n+  // first `await` is an operator.)\n+  //\n+  // The value of each entry indicates the conclusion:\n+  // * true means 'await' looks like an identifier, thus '/' is the division\n+  //   operator.\n+  // * false means 'await' looks like an operator, thus '/' begins a regular\n+  //   expression literal.\n+  std::unordered_map<parse_expression_cache_key, bool,\n+                     parse_expression_cache_key::hash>\n+      await_slash_is_identifier_divide_cache_;\n+\n #if QLJS_HAVE_SETJMP\n   bool have_fatal_parse_error_jmp_buf_ = false;\n   std::jmp_buf fatal_parse_error_jmp_buf_;"
      }
    ],
    "lines_added": 78,
    "lines_removed": 2
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "new_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "old_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "new_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 1.0,
    "is_pair_significant": false,
    "pair_p_value": 1.0,
    "is_binom_significant": false,
    "binom_p_value": 1.0,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.9999993137955374,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.4618103285084385,
    "relative_improvement": 0.0013732491073880024,
    "absolute_improvement_ms": 1.6666666666669272,
    "old_mean_ms": 1213.666666666667,
    "new_mean_ms": 1212.0,
    "old_std_ms": 13.514572807192977,
    "new_std_ms": 8.051557998728983,
    "effect_size_cohens_d": 0.14983088986118545,
    "old_ci95_ms": [
      1208.6202422447968,
      1218.7130910885369
    ],
    "new_ci95_ms": [
      1208.993498832811,
      1215.006501167189
    ],
    "old_ci99_ms": [
      1206.8655266607577,
      1220.467806672576
    ],
    "new_ci99_ms": [
      1207.9480944017773,
      1216.0519055982227
    ],
    "new_times_s": [
      1.21,
      1.21,
      1.21,
      1.2,
      1.22,
      1.2,
      1.21,
      1.2,
      1.2,
      1.21,
      1.21,
      1.22,
      1.22,
      1.21,
      1.21,
      1.22,
      1.21,
      1.21,
      1.21,
      1.21,
      1.22,
      1.21,
      1.21,
      1.21,
      1.22,
      1.23,
      1.2,
      1.22,
      1.21,
      1.21,
      1.23
    ],
    "old_times_s": [
      1.22,
      1.2,
      1.21,
      1.21,
      1.21,
      1.23,
      1.21,
      1.2,
      1.21,
      1.21,
      1.2,
      1.21,
      1.21,
      1.21,
      1.23,
      1.21,
      1.22,
      1.2,
      1.22,
      1.21,
      1.22,
      1.21,
      1.2,
      1.22,
      1.21,
      1.21,
      1.2,
      1.22,
      1.22,
      1.27,
      1.22
    ]
  },
  "tests": {
    "total_tests": 2,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 1,
    "significant_mannwhitney_regressions_tests": [
      "quick-lint-js-test"
    ],
    "tests": [
      {
        "test_name": "quick-lint-js-test",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999993241291822,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.9873120180621311,
        "relative_improvement": -0.006284916201117308,
        "absolute_improvement_ms": -3.1034482758621196,
        "old_mean_ms": 493.7931034482759,
        "new_mean_ms": 496.89655172413796,
        "old_std_ms": 5.614899250748776,
        "new_std_ms": 5.413902920037101,
        "effect_size_cohens_d": -0.5626962871260586,
        "old_ci95_ms": [
          491.65730999763593,
          495.9288968989158
        ],
        "new_ci95_ms": [
          494.83721318881635,
          498.95589025945964
        ],
        "old_ci99_ms": [
          490.9119585165117,
          496.67424838004007
        ],
        "new_ci99_ms": [
          494.11854302575426,
          499.6745604225217
        ],
        "new_times": [
          0.49,
          0.49,
          0.5,
          0.5,
          0.5,
          0.5,
          0.49,
          0.5,
          0.49,
          0.5,
          0.5,
          0.49,
          0.49,
          0.5,
          0.5,
          0.5,
          0.5,
          0.49,
          0.51,
          0.49,
          0.49,
          0.5,
          0.5,
          0.5,
          0.49,
          0.5,
          0.5,
          0.5,
          0.5
        ],
        "old_times": [
          0.49,
          0.49,
          0.49,
          0.5,
          0.49,
          0.49,
          0.5,
          0.49,
          0.49,
          0.49,
          0.5,
          0.49,
          0.49,
          0.49,
          0.49,
          0.49,
          0.49,
          0.5,
          0.51,
          0.49,
          0.49,
          0.5,
          0.5,
          0.5,
          0.49,
          0.5,
          0.49,
          0.49,
          0.5
        ]
      },
      {
        "test_name": "quick-lint-js-test-cli",
        "is_significant": false,
        "p_value": 0.9999986955029835,
        "is_pair_significant": false,
        "pair_p_value": 0.9999971114654965,
        "is_binom_significant": false,
        "binom_p_value": 0.9999999981373549,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999978486102682,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.16714290224817413,
        "relative_improvement": 0.0076045627376425924,
        "absolute_improvement_ms": 0.6896551724137889,
        "old_mean_ms": 90.68965517241377,
        "new_mean_ms": 89.99999999999999,
        "old_std_ms": 3.713906763541038,
        "new_std_ms": 1.4123431441001795e-14,
        "effect_size_cohens_d": 0.2626128657194435,
        "old_ci95_ms": [
          89.27696059186532,
          92.10234975296223
        ],
        "new_ci95_ms": [
          89.99999999999999,
          89.99999999999999
        ],
        "old_ci99_ms": [
          88.7839569272682,
          92.59535341755934
        ],
        "new_ci99_ms": [
          89.99999999999997,
          90.0
        ],
        "new_times": [
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09
        ],
        "old_times": [
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.11,
          0.09
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}