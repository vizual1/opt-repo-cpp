{
  "metadata": {
    "collection_date": "2026-01-11T17:52:32.397760",
    "repository": "https://github.com/google/snappy",
    "repository_name": "google/snappy"
  },
  "commit_info": {
    "old_sha": "984b191f0fefdeb17050b42a90b7625999c13b8d",
    "new_sha": "a2d219a8a801ae522bac8e966de005fcb336821b",
    "commit_message": [
      "Modify MemCopy64 to use AVX 32 byte copies instead of SSE2 16 byte copies on capable x86 platforms.  This gives an average speedup of 6.87% on Milan and 1.90% on Skylake.\n\nPiperOrigin-RevId: 480370725"
    ],
    "commit_date": "2022-10-11T16:00:34+00:00",
    "patch": [
      "--- snappy.cc\n@@ -989,27 +989,36 @@ inline bool Copy64BytesWithPatternExtension(ptrdiff_t dst, size_t offset) {\n // so gives better performance.  [src, src + size) must not overlap with\n // [dst, dst + size), but [src, src + 64) may overlap with [dst, dst + 64).\n void MemCopy64(char* dst, const void* src, size_t size) {\n-  // Always copy this many bytes, test if we need to copy more.\n+  // Always copy this many bytes.  If that's below size then copy the full 64.\n   constexpr int kShortMemCopy = 32;\n-  // We're always allowed to copy 64 bytes, so if we exceed kShortMemCopy just\n-  // copy 64 rather than the exact amount.\n-  constexpr int kLongMemCopy = 64;\n \n-  assert(size <= kLongMemCopy);\n+  assert(size <= 64);\n   assert(std::less_equal<const void*>()(static_cast<const char*>(src) + size,\n                                         dst) ||\n          std::less_equal<const void*>()(dst + size, src));\n \n   // We know that src and dst are at least size bytes apart. However, because we\n   // might copy more than size bytes the copy still might overlap past size.\n-  // E.g. if src and dst appear consecutively in memory (src + size == dst).\n+  // E.g. if src and dst appear consecutively in memory (src + size >= dst).\n+  // TODO: Investigate wider copies on other platforms.\n+#if defined(__x86_64__) && defined(__AVX__)\n+  assert(kShortMemCopy <= 32);\n+  __m256i data = _mm256_lddqu_si256(static_cast<const __m256i *>(src));\n+  _mm256_storeu_si256(reinterpret_cast<__m256i *>(dst), data);\n+  // Profiling shows that nearly all copies are short.\n+  if (SNAPPY_PREDICT_FALSE(size > kShortMemCopy)) {\n+    data = _mm256_lddqu_si256(static_cast<const __m256i *>(src) + 1);\n+    _mm256_storeu_si256(reinterpret_cast<__m256i *>(dst) + 1, data);\n+  }\n+#else\n   std::memmove(dst, src, kShortMemCopy);\n   // Profiling shows that nearly all copies are short.\n   if (SNAPPY_PREDICT_FALSE(size > kShortMemCopy)) {\n     std::memmove(dst + kShortMemCopy,\n                  static_cast<const uint8_t*>(src) + kShortMemCopy,\n-                 kLongMemCopy - kShortMemCopy);\n+                 64 - kShortMemCopy);\n   }\n+#endif\n }\n \n void MemCopy64(ptrdiff_t dst, const void* src, size_t size) {"
    ],
    "files_changed": [
      {
        "filename": "snappy.cc",
        "status": "modified",
        "additions": 16,
        "deletions": 7,
        "changes": 23,
        "patch": "@@ -989,27 +989,36 @@ inline bool Copy64BytesWithPatternExtension(ptrdiff_t dst, size_t offset) {\n // so gives better performance.  [src, src + size) must not overlap with\n // [dst, dst + size), but [src, src + 64) may overlap with [dst, dst + 64).\n void MemCopy64(char* dst, const void* src, size_t size) {\n-  // Always copy this many bytes, test if we need to copy more.\n+  // Always copy this many bytes.  If that's below size then copy the full 64.\n   constexpr int kShortMemCopy = 32;\n-  // We're always allowed to copy 64 bytes, so if we exceed kShortMemCopy just\n-  // copy 64 rather than the exact amount.\n-  constexpr int kLongMemCopy = 64;\n \n-  assert(size <= kLongMemCopy);\n+  assert(size <= 64);\n   assert(std::less_equal<const void*>()(static_cast<const char*>(src) + size,\n                                         dst) ||\n          std::less_equal<const void*>()(dst + size, src));\n \n   // We know that src and dst are at least size bytes apart. However, because we\n   // might copy more than size bytes the copy still might overlap past size.\n-  // E.g. if src and dst appear consecutively in memory (src + size == dst).\n+  // E.g. if src and dst appear consecutively in memory (src + size >= dst).\n+  // TODO: Investigate wider copies on other platforms.\n+#if defined(__x86_64__) && defined(__AVX__)\n+  assert(kShortMemCopy <= 32);\n+  __m256i data = _mm256_lddqu_si256(static_cast<const __m256i *>(src));\n+  _mm256_storeu_si256(reinterpret_cast<__m256i *>(dst), data);\n+  // Profiling shows that nearly all copies are short.\n+  if (SNAPPY_PREDICT_FALSE(size > kShortMemCopy)) {\n+    data = _mm256_lddqu_si256(static_cast<const __m256i *>(src) + 1);\n+    _mm256_storeu_si256(reinterpret_cast<__m256i *>(dst) + 1, data);\n+  }\n+#else\n   std::memmove(dst, src, kShortMemCopy);\n   // Profiling shows that nearly all copies are short.\n   if (SNAPPY_PREDICT_FALSE(size > kShortMemCopy)) {\n     std::memmove(dst + kShortMemCopy,\n                  static_cast<const uint8_t*>(src) + kShortMemCopy,\n-                 kLongMemCopy - kShortMemCopy);\n+                 64 - kShortMemCopy);\n   }\n+#endif\n }\n \n void MemCopy64(ptrdiff_t dst, const void* src, size_t size) {"
      }
    ],
    "lines_added": 16,
    "lines_removed": 7
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DSNAPPY_BUILD_TESTS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "new_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DSNAPPY_BUILD_TESTS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "old_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "new_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 1.0,
    "is_pair_significant": false,
    "pair_p_value": 1.0,
    "is_binom_significant": false,
    "binom_p_value": 1.0,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.9999991420356624,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.07641883197355988,
    "relative_improvement": 0.0023288158618236803,
    "absolute_improvement_ms": 24.000000000004462,
    "old_mean_ms": 10305.66666666667,
    "new_mean_ms": 10281.666666666664,
    "old_std_ms": 102.27357946933924,
    "new_std_ms": 79.96047874368637,
    "effect_size_cohens_d": 0.26144501910609114,
    "old_ci95_ms": [
      10267.477084464601,
      10343.856248868738
    ],
    "new_ci95_ms": [
      10251.808933205657,
      10311.524400127671
    ],
    "old_ci99_ms": [
      10254.198008145237,
      10357.135325188101
    ],
    "new_ci99_ms": [
      10241.426962561041,
      10321.906370772287
    ],
    "new_times_s": [
      10.21,
      10.22,
      10.21,
      10.28,
      10.4,
      10.21,
      10.43,
      10.41,
      10.17,
      10.05,
      10.35,
      10.39,
      10.28,
      10.36,
      10.42,
      10.25,
      10.26,
      10.24,
      10.24,
      10.25,
      10.26,
      10.3,
      10.25,
      10.28,
      10.29,
      10.26,
      10.32,
      10.25,
      10.27,
      10.27,
      10.28
    ],
    "old_times_s": [
      10.39,
      10.2,
      9.97,
      10.18,
      10.3,
      10.21,
      10.43,
      10.44,
      10.3,
      10.33,
      10.43,
      10.4,
      10.25,
      10.25,
      10.45,
      10.27,
      10.47,
      10.4,
      10.27,
      10.28,
      10.26,
      10.26,
      10.26,
      10.33,
      10.3,
      10.24,
      10.31,
      10.36,
      10.3,
      10.29,
      10.43
    ]
  },
  "tests": {
    "total_tests": 1,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 0,
    "significant_mannwhitney_regressions_tests": [],
    "tests": [
      {
        "test_name": "snappy_unittest",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999987356220623,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.07146630138062189,
        "relative_improvement": 0.002442206684286111,
        "absolute_improvement_ms": 25.172413793104198,
        "old_mean_ms": 10307.241379310344,
        "new_mean_ms": 10282.068965517241,
        "old_std_ms": 102.70959586983017,
        "new_std_ms": 80.28428552626626,
        "effect_size_cohens_d": 0.2730747083929046,
        "old_ci95_ms": [
          10268.17273847099,
          10346.310020149698
        ],
        "new_ci95_ms": [
          10251.530456532695,
          10312.607474501785
        ],
        "old_ci99_ms": [
          10254.538522434605,
          10359.944236186084
        ],
        "new_ci99_ms": [
          10240.87309502794,
          10323.26483600654
        ],
        "new_times": [
          10.21,
          10.28,
          10.4,
          10.2,
          10.42,
          10.41,
          10.17,
          10.05,
          10.35,
          10.39,
          10.28,
          10.35,
          10.42,
          10.25,
          10.26,
          10.23,
          10.24,
          10.25,
          10.26,
          10.3,
          10.24,
          10.28,
          10.29,
          10.26,
          10.32,
          10.25,
          10.27,
          10.27,
          10.28
        ],
        "old_times": [
          9.97,
          10.18,
          10.3,
          10.2,
          10.43,
          10.44,
          10.29,
          10.33,
          10.43,
          10.4,
          10.25,
          10.25,
          10.45,
          10.27,
          10.47,
          10.4,
          10.26,
          10.28,
          10.26,
          10.26,
          10.26,
          10.32,
          10.29,
          10.24,
          10.31,
          10.36,
          10.3,
          10.28,
          10.43
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}