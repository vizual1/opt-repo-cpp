{
  "metadata": {
    "collection_date": "2026-01-11T17:52:59.694515",
    "repository": "https://github.com/quick-lint/quick-lint-js",
    "repository_name": "quick-lint/quick-lint-js"
  },
  "commit_info": {
    "old_sha": "715745e2aa9331e1b80a22bc2fa7cf353ab473e1",
    "new_sha": "423702ea490a6cd4aba2b1ce8a3199076c3d7f66",
    "commit_message": [
      "perf(debug): incrementally build vector profiling histograms\n\nInstead of processing all events, process only new events, caching old\nhistogram data. This improves performance of the debug server\nsignificantly, especially for long sessions."
    ],
    "commit_date": "2022-10-28T05:12:02+00:00",
    "patch": [
      "--- src/quick-lint-js/debug/debug-server.cpp\n@@ -30,10 +30,6 @@\n using namespace std::literals::string_view_literals;\n \n namespace quick_lint_js {\n-namespace {\n-void write_vector_profiler_stats(byte_buffer &out_json);\n-}\n-\n class trace_flusher_websocket_backend final : public trace_flusher_backend {\n  public:\n   explicit trace_flusher_websocket_backend(::mg_connection *connection,\n@@ -258,7 +254,7 @@ void debug_server::http_server_callback(::mg_connection *c, int ev,\n     ::mg_http_message *hm = static_cast<::mg_http_message *>(ev_data);\n     if (::mg_http_match_uri(hm, \"/vector-profiler-stats\")) {\n       byte_buffer json;\n-      write_vector_profiler_stats(json);\n+      this->write_vector_profiler_stats(json);\n \n       // TODO(strager): Optimize.\n       std::string json_copy;\n@@ -328,15 +324,14 @@ void debug_server::wakeup_pipe_callback(::mg_connection *c, int ev,\n   }\n }\n \n-namespace {\n-void write_vector_profiler_stats(byte_buffer &out_json) {\n+void debug_server::write_vector_profiler_stats(byte_buffer &out_json) {\n   out_json.append_copy(u8R\"--({\"maxSizeHistogramByOwner\":{)--\"_sv);\n \n #if QLJS_FEATURE_VECTOR_PROFILING\n-  vector_max_size_histogram_by_owner max_size_histogram;\n-  max_size_histogram.add_entries(vector_instrumentation::instance.entries());\n+  this->max_size_histogram_.add_entries(\n+      vector_instrumentation::instance.take_entries());\n   bool need_comma = false;\n-  for (auto &[owner, histogram] : max_size_histogram.histogram()) {\n+  for (auto &[owner, histogram] : this->max_size_histogram_.histogram()) {\n     if (need_comma) {\n       out_json.append_copy(u8',');\n     }\n@@ -376,7 +371,6 @@ void write_vector_profiler_stats(byte_buffer &out_json) {\n   out_json.append_copy(u8\"}}\"_sv);\n }\n }\n-}\n \n #endif\n \n--- src/quick-lint-js/debug/debug-server.h\n@@ -13,10 +13,12 @@\n #include <mongoose.h>\n #include <optional>\n #include <quick-lint-js/container/result.h>\n+#include <quick-lint-js/container/vector-profiler.h>\n #include <quick-lint-js/port/thread.h>\n #include <string>\n \n namespace quick_lint_js {\n+class byte_buffer;\n class trace_flusher;\n class trace_flusher_websocket_backend;\n \n@@ -63,6 +65,7 @@ class debug_server {\n   void begin_closing_all_connections(::mg_mgr *);\n   void http_server_callback(::mg_connection *c, int ev, void *ev_data) noexcept;\n   void wakeup_pipe_callback(::mg_connection *c, int ev, void *ev_data) noexcept;\n+  void write_vector_profiler_stats(byte_buffer &out_json);\n \n   struct init_data {\n     // HACK(strager): Clang 11 with libstdc++ 12 requires a user-declared (not\n@@ -100,6 +103,9 @@ class debug_server {\n   // Each backend is associated with one WebSocket connection.\n   std::vector<std::unique_ptr<trace_flusher_websocket_backend>>\n       tracer_backends_;\n+#if QLJS_FEATURE_VECTOR_PROFILING\n+  vector_max_size_histogram_by_owner max_size_histogram_;\n+#endif\n \n   friend class trace_flusher_websocket_backend;\n };"
    ],
    "files_changed": [
      {
        "filename": "src/quick-lint-js/debug/debug-server.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 11,
        "changes": 16,
        "patch": "@@ -30,10 +30,6 @@\n using namespace std::literals::string_view_literals;\n \n namespace quick_lint_js {\n-namespace {\n-void write_vector_profiler_stats(byte_buffer &out_json);\n-}\n-\n class trace_flusher_websocket_backend final : public trace_flusher_backend {\n  public:\n   explicit trace_flusher_websocket_backend(::mg_connection *connection,\n@@ -258,7 +254,7 @@ void debug_server::http_server_callback(::mg_connection *c, int ev,\n     ::mg_http_message *hm = static_cast<::mg_http_message *>(ev_data);\n     if (::mg_http_match_uri(hm, \"/vector-profiler-stats\")) {\n       byte_buffer json;\n-      write_vector_profiler_stats(json);\n+      this->write_vector_profiler_stats(json);\n \n       // TODO(strager): Optimize.\n       std::string json_copy;\n@@ -328,15 +324,14 @@ void debug_server::wakeup_pipe_callback(::mg_connection *c, int ev,\n   }\n }\n \n-namespace {\n-void write_vector_profiler_stats(byte_buffer &out_json) {\n+void debug_server::write_vector_profiler_stats(byte_buffer &out_json) {\n   out_json.append_copy(u8R\"--({\"maxSizeHistogramByOwner\":{)--\"_sv);\n \n #if QLJS_FEATURE_VECTOR_PROFILING\n-  vector_max_size_histogram_by_owner max_size_histogram;\n-  max_size_histogram.add_entries(vector_instrumentation::instance.entries());\n+  this->max_size_histogram_.add_entries(\n+      vector_instrumentation::instance.take_entries());\n   bool need_comma = false;\n-  for (auto &[owner, histogram] : max_size_histogram.histogram()) {\n+  for (auto &[owner, histogram] : this->max_size_histogram_.histogram()) {\n     if (need_comma) {\n       out_json.append_copy(u8',');\n     }\n@@ -376,7 +371,6 @@ void write_vector_profiler_stats(byte_buffer &out_json) {\n   out_json.append_copy(u8\"}}\"_sv);\n }\n }\n-}\n \n #endif\n "
      },
      {
        "filename": "src/quick-lint-js/debug/debug-server.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "patch": "@@ -13,10 +13,12 @@\n #include <mongoose.h>\n #include <optional>\n #include <quick-lint-js/container/result.h>\n+#include <quick-lint-js/container/vector-profiler.h>\n #include <quick-lint-js/port/thread.h>\n #include <string>\n \n namespace quick_lint_js {\n+class byte_buffer;\n class trace_flusher;\n class trace_flusher_websocket_backend;\n \n@@ -63,6 +65,7 @@ class debug_server {\n   void begin_closing_all_connections(::mg_mgr *);\n   void http_server_callback(::mg_connection *c, int ev, void *ev_data) noexcept;\n   void wakeup_pipe_callback(::mg_connection *c, int ev, void *ev_data) noexcept;\n+  void write_vector_profiler_stats(byte_buffer &out_json);\n \n   struct init_data {\n     // HACK(strager): Clang 11 with libstdc++ 12 requires a user-declared (not\n@@ -100,6 +103,9 @@ class debug_server {\n   // Each backend is associated with one WebSocket connection.\n   std::vector<std::unique_ptr<trace_flusher_websocket_backend>>\n       tracer_backends_;\n+#if QLJS_FEATURE_VECTOR_PROFILING\n+  vector_max_size_histogram_by_owner max_size_histogram_;\n+#endif\n \n   friend class trace_flusher_websocket_backend;\n };"
      }
    ],
    "lines_added": 11,
    "lines_removed": 11
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_USE_BUNDLED_GTEST=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "new_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_USE_BUNDLED_GTEST=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "old_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "new_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 1.0,
    "is_pair_significant": false,
    "pair_p_value": 1.0,
    "is_binom_significant": false,
    "binom_p_value": 1.0,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.999999331982879,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.8233483751853069,
    "relative_improvement": -0.0018148820326679023,
    "absolute_improvement_ms": -1.6666666666668162,
    "old_mean_ms": 918.3333333333335,
    "new_mean_ms": 920.0000000000002,
    "old_std_ms": 5.306686305052328,
    "new_std_ms": 7.4278135270820815,
    "effect_size_cohens_d": -0.258198889747184,
    "old_ci95_ms": [
      916.3517841011768,
      920.31488256549
    ],
    "new_ci95_ms": [
      917.226408846293,
      922.7735911537075
    ],
    "old_ci99_ms": [
      915.6627704496223,
      921.0038962170446
    ],
    "new_ci99_ms": [
      916.2619906336528,
      923.7380093663478
    ],
    "new_times_s": [
      0.92,
      0.91,
      0.93,
      0.91,
      0.91,
      0.92,
      0.91,
      0.91,
      0.92,
      0.93,
      0.92,
      0.91,
      0.93,
      0.93,
      0.93,
      0.92,
      0.91,
      0.92,
      0.92,
      0.92,
      0.92,
      0.93,
      0.92,
      0.93,
      0.92,
      0.91,
      0.92,
      0.92,
      0.93,
      0.92,
      0.92
    ],
    "old_times_s": [
      0.9,
      0.92,
      0.92,
      0.92,
      0.92,
      0.91,
      0.92,
      0.91,
      0.92,
      0.92,
      0.92,
      0.92,
      0.91,
      0.92,
      0.92,
      0.92,
      0.92,
      0.92,
      0.92,
      0.92,
      0.92,
      0.92,
      0.91,
      0.91,
      0.93,
      0.92,
      0.93,
      0.91,
      0.92,
      0.91,
      0.92
    ]
  },
  "tests": {
    "total_tests": 2,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 0,
    "significant_mannwhitney_regressions_tests": [],
    "tests": [
      {
        "test_name": "quick-lint-js-test",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999990873905196,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.7845822394929718,
        "relative_improvement": -0.0022421524663676653,
        "absolute_improvement_ms": -1.3793103448277444,
        "old_mean_ms": 615.1724137931034,
        "new_mean_ms": 616.5517241379312,
        "old_std_ms": 5.085476277156082,
        "new_std_ms": 6.138788892284819,
        "effect_size_cohens_d": -0.24469785087958404,
        "old_ci95_ms": [
          613.2380020715242,
          617.1068255146826
        ],
        "new_ci95_ms": [
          614.2166537251798,
          618.8867945506826
        ],
        "old_ci99_ms": [
          612.5629290014429,
          617.781898584764
        ],
        "new_ci99_ms": [
          613.4017583568321,
          619.7016899190301
        ],
        "new_times": [
          0.63,
          0.61,
          0.61,
          0.62,
          0.61,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.62,
          0.62,
          0.63,
          0.62,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.61,
          0.61,
          0.61,
          0.62,
          0.62,
          0.61
        ],
        "old_times": [
          0.62,
          0.61,
          0.62,
          0.61,
          0.62,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.61,
          0.61,
          0.62,
          0.61,
          0.62,
          0.61,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.61,
          0.62,
          0.62,
          0.62,
          0.61,
          0.61,
          0.61,
          0.62
        ]
      },
      {
        "test_name": "quick-lint-js-test-cli",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 1.0,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999999638108507,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 1.0,
        "relative_improvement": 0.0,
        "absolute_improvement_ms": 0.0,
        "old_mean_ms": 100.00000000000003,
        "new_mean_ms": 100.00000000000003,
        "old_std_ms": 2.824686288200359e-14,
        "new_std_ms": 2.824686288200359e-14,
        "effect_size_cohens_d": 0.0,
        "old_ci95_ms": [
          100.00000000000001,
          100.00000000000004
        ],
        "new_ci95_ms": [
          100.00000000000001,
          100.00000000000004
        ],
        "old_ci99_ms": [
          100.00000000000001,
          100.00000000000004
        ],
        "new_ci99_ms": [
          100.00000000000001,
          100.00000000000004
        ],
        "new_times": [
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1
        ],
        "old_times": [
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1,
          0.1
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}