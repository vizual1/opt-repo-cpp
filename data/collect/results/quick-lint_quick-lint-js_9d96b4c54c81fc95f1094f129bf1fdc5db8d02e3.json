{
  "metadata": {
    "collection_date": "2026-01-14T18:38:13.560144",
    "repository": "https://github.com/quick-lint/quick-lint-js",
    "repository_name": "quick-lint/quick-lint-js"
  },
  "commit_info": {
    "old_sha": "b3da0e4c21ae076e0395e44c081b37b4cfa9e17d",
    "new_sha": "9d96b4c54c81fc95f1094f129bf1fdc5db8d02e3",
    "commit_message": [
      "Garbage-collect expression ASTs\n\nIn parse_and_visit_expression, we know that an allocated expression\nisn't used after calling visit_expression. Save memory by deleting the\nentire expression tree allocated by parse_expression after calling\nvisit_expression.\n\nThis commit should not change behavior.\n\nThis memory usage optimization improves parsing performance:\n\n      --------------------------------------------------------------------------\n      When       Benchmark                     Time             CPU   Iterations\n      --------------------------------------------------------------------------\n      before     benchmark_parse_file    1634589 ns      1632770 ns         1710\n      after      benchmark_parse_file    1621339 ns      1619349 ns         1747"
    ],
    "commit_date": "2021-11-28T08:36:18+00:00",
    "patch": [
      "--- src/quick-lint-js/expression.h\n@@ -130,6 +130,8 @@ class expression_arena {\n     return &this->buffering_visitor_memory_;\n   }\n \n+  monotonic_allocator *allocator() noexcept { return &this->allocator_; }\n+\n  private:\n   template <class T, class... Args>\n   T *allocate(Args &&... args) {\n--- src/quick-lint-js/linked-bump-allocator.h\n@@ -17,6 +17,12 @@\n #include <sanitizer/asan_interface.h>\n #endif\n \n+#if defined(QLJS_DEBUG) && QLJS_DEBUG\n+#define QLJS_DEBUG_BUMP_ALLOCATOR 1\n+#else\n+#define QLJS_DEBUG_BUMP_ALLOCATOR 0\n+#endif\n+\n namespace quick_lint_js {\n // A memory allocator with a few features:\n //\n@@ -121,6 +127,7 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n   template <class T>\n   bool try_grow_array_in_place(T* array, std::size_t old_size,\n                                std::size_t new_size) {\n+    this->assert_not_disabled();\n     QLJS_ASSERT(new_size > old_size);\n     std::size_t old_byte_size = this->align_up(old_size * sizeof(T));\n     bool array_is_last_allocation =\n@@ -156,6 +163,33 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n     return this;\n   }\n \n+  class disable_guard {\n+   public:\n+    ~disable_guard() {\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+      this->alloc_->disabled_count_ -= 1;\n+#endif\n+    }\n+\n+   private:\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    explicit disable_guard(linked_bump_allocator* alloc) noexcept\n+        : alloc_(alloc) {\n+      this->alloc_->disabled_count_ -= 1;\n+    }\n+#else\n+    explicit disable_guard(linked_bump_allocator*) noexcept {}\n+#endif\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    linked_bump_allocator* alloc_;\n+#endif\n+\n+    friend class linked_bump_allocator;\n+  };\n+\n+  [[nodiscard]] disable_guard disable() noexcept { return disable_guard(this); }\n+\n  protected:\n   void* do_allocate(std::size_t bytes, std::size_t align) override {\n     QLJS_ASSERT(align <= Alignment);\n@@ -230,6 +264,7 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n #endif\n \n   [[nodiscard]] void* allocate_bytes(std::size_t size) {\n+    this->assert_not_disabled();\n     QLJS_SLOW_ASSERT(size % Alignment == 0);\n     if (this->remaining_bytes_in_current_chunk() < size) {\n       this->append_chunk(maximum(size, this->default_chunk_size));\n@@ -268,9 +303,23 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n     this->chunk_end_ = this->chunk_->data_end();\n   }\n \n+  void assert_not_disabled() const {\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    QLJS_ALWAYS_ASSERT(!this->is_disabled());\n+#endif\n+  }\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+  bool is_disabled() const noexcept { return this->disabled_count_ > 0; }\n+#endif\n+\n   chunk_header* chunk_ = nullptr;\n   char* next_allocation_ = nullptr;\n   char* chunk_end_ = nullptr;\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+  int disabled_count_ = 0;\n+#endif\n };\n }\n \n--- src/quick-lint-js/parse.h\n@@ -3673,8 +3673,16 @@ class parser {\n \n   template <QLJS_PARSE_VISITOR Visitor>\n   void parse_and_visit_expression(Visitor &v, precedence prec) {\n+    monotonic_allocator &alloc = *this->expressions_.allocator();\n+    auto rewind_state = alloc.prepare_for_rewind();\n+\n     expression *ast = this->parse_expression(prec);\n-    this->visit_expression(ast, v, variable_context::rhs);\n+    {\n+      auto disable_guard = alloc.disable();\n+      this->visit_expression(ast, v, variable_context::rhs);\n+    }\n+\n+    alloc.rewind(std::move(rewind_state));\n   }\n \n   expression *parse_expression(precedence);"
    ],
    "files_changed": [
      {
        "filename": "src/quick-lint-js/expression.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "patch": "@@ -130,6 +130,8 @@ class expression_arena {\n     return &this->buffering_visitor_memory_;\n   }\n \n+  monotonic_allocator *allocator() noexcept { return &this->allocator_; }\n+\n  private:\n   template <class T, class... Args>\n   T *allocate(Args &&... args) {"
      },
      {
        "filename": "src/quick-lint-js/linked-bump-allocator.h",
        "status": "modified",
        "additions": 49,
        "deletions": 0,
        "changes": 49,
        "patch": "@@ -17,6 +17,12 @@\n #include <sanitizer/asan_interface.h>\n #endif\n \n+#if defined(QLJS_DEBUG) && QLJS_DEBUG\n+#define QLJS_DEBUG_BUMP_ALLOCATOR 1\n+#else\n+#define QLJS_DEBUG_BUMP_ALLOCATOR 0\n+#endif\n+\n namespace quick_lint_js {\n // A memory allocator with a few features:\n //\n@@ -121,6 +127,7 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n   template <class T>\n   bool try_grow_array_in_place(T* array, std::size_t old_size,\n                                std::size_t new_size) {\n+    this->assert_not_disabled();\n     QLJS_ASSERT(new_size > old_size);\n     std::size_t old_byte_size = this->align_up(old_size * sizeof(T));\n     bool array_is_last_allocation =\n@@ -156,6 +163,33 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n     return this;\n   }\n \n+  class disable_guard {\n+   public:\n+    ~disable_guard() {\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+      this->alloc_->disabled_count_ -= 1;\n+#endif\n+    }\n+\n+   private:\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    explicit disable_guard(linked_bump_allocator* alloc) noexcept\n+        : alloc_(alloc) {\n+      this->alloc_->disabled_count_ -= 1;\n+    }\n+#else\n+    explicit disable_guard(linked_bump_allocator*) noexcept {}\n+#endif\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    linked_bump_allocator* alloc_;\n+#endif\n+\n+    friend class linked_bump_allocator;\n+  };\n+\n+  [[nodiscard]] disable_guard disable() noexcept { return disable_guard(this); }\n+\n  protected:\n   void* do_allocate(std::size_t bytes, std::size_t align) override {\n     QLJS_ASSERT(align <= Alignment);\n@@ -230,6 +264,7 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n #endif\n \n   [[nodiscard]] void* allocate_bytes(std::size_t size) {\n+    this->assert_not_disabled();\n     QLJS_SLOW_ASSERT(size % Alignment == 0);\n     if (this->remaining_bytes_in_current_chunk() < size) {\n       this->append_chunk(maximum(size, this->default_chunk_size));\n@@ -268,9 +303,23 @@ class linked_bump_allocator : public boost::container::pmr::memory_resource {\n     this->chunk_end_ = this->chunk_->data_end();\n   }\n \n+  void assert_not_disabled() const {\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+    QLJS_ALWAYS_ASSERT(!this->is_disabled());\n+#endif\n+  }\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+  bool is_disabled() const noexcept { return this->disabled_count_ > 0; }\n+#endif\n+\n   chunk_header* chunk_ = nullptr;\n   char* next_allocation_ = nullptr;\n   char* chunk_end_ = nullptr;\n+\n+#if QLJS_DEBUG_BUMP_ALLOCATOR\n+  int disabled_count_ = 0;\n+#endif\n };\n }\n "
      },
      {
        "filename": "src/quick-lint-js/parse.h",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "patch": "@@ -3673,8 +3673,16 @@ class parser {\n \n   template <QLJS_PARSE_VISITOR Visitor>\n   void parse_and_visit_expression(Visitor &v, precedence prec) {\n+    monotonic_allocator &alloc = *this->expressions_.allocator();\n+    auto rewind_state = alloc.prepare_for_rewind();\n+\n     expression *ast = this->parse_expression(prec);\n-    this->visit_expression(ast, v, variable_context::rhs);\n+    {\n+      auto disable_guard = alloc.disable();\n+      this->visit_expression(ast, v, variable_context::rhs);\n+    }\n+\n+    alloc.rewind(std::move(rewind_state));\n   }\n \n   expression *parse_expression(precedence);"
      }
    ],
    "lines_added": 60,
    "lines_removed": 1
  },
  "issues": [],
  "pull_requests": [],
  "build_info": {
    "old_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "new_build_script": "#!/bin/bash\n#!/bin/bash\ncmake -S /test_workspace/workspace/old -B /test_workspace/workspace/old/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBENCHMARK_ENABLE_GTEST_TESTS=ON -DBUILD_TESTING=ON -DBENCHMARK_ENABLE_TESTING=ON -DBENCHMARK_ENABLE_ASSEMBLY_TESTS=ON",
    "old_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "new_test_script": "#!/bin/bash\ncmake --build /test_workspace/workspace/old/build -- -j 1",
    "build_system": "cmake"
  },
  "performance_analysis": {
    "is_significant": false,
    "p_value": 1.0,
    "is_pair_significant": false,
    "pair_p_value": 0.9999999999999998,
    "is_binom_significant": false,
    "binom_p_value": 1.0,
    "is_wilcoxon_significant": false,
    "wilcoxon_p_value": 0.999999172040422,
    "is_mannwhitney_significant": false,
    "mannwhitney_p_value": 0.8667877279592915,
    "relative_improvement": 0.0003428179636612277,
    "absolute_improvement_ms": 0.3333333333332966,
    "old_mean_ms": 972.3333333333331,
    "new_mean_ms": 971.9999999999999,
    "old_std_ms": 13.817363722139085,
    "new_std_ms": 7.143842296595075,
    "effect_size_cohens_d": 0.03030590931403558,
    "old_ci95_ms": [
      967.1738449256677,
      977.4928217409986
    ],
    "new_ci95_ms": [
      969.3324454464191,
      974.6675545535805
    ],
    "old_ci99_ms": [
      965.3798153400139,
      979.2868513266524
    ],
    "new_ci99_ms": [
      968.404897710609,
      975.5951022893908
    ],
    "new_times_s": [
      0.97,
      0.96,
      0.97,
      0.98,
      0.98,
      0.98,
      0.97,
      0.97,
      0.98,
      0.97,
      0.97,
      0.97,
      0.97,
      0.97,
      0.96,
      0.98,
      0.97,
      0.98,
      0.98,
      0.98,
      0.96,
      0.97,
      0.97,
      0.96,
      0.98,
      0.97,
      0.97,
      0.96,
      0.98,
      0.98,
      0.97
    ],
    "old_times_s": [
      0.96,
      0.97,
      0.97,
      0.97,
      0.96,
      0.97,
      0.97,
      0.96,
      0.96,
      0.97,
      0.96,
      0.97,
      0.96,
      1.02,
      0.96,
      0.98,
      0.98,
      0.96,
      0.97,
      0.97,
      0.97,
      0.99,
      0.97,
      0.97,
      0.96,
      1.0,
      0.97,
      0.97,
      0.97,
      0.97,
      1.0
    ]
  },
  "tests": {
    "total_tests": 2,
    "significant_improvements": 0,
    "significant_improvements_tests": [],
    "significant_regressions": 0,
    "significant_regressions_tests": [],
    "significant_pair_improvements": 0,
    "significant_pair_improvements_tests": [],
    "significant_pair_regressions": 0,
    "significant_pair_regressions_tests": [],
    "significant_binom_improvements": 0,
    "significant_binom_improvements_tests": [],
    "significant_binom_regressions": 0,
    "significant_binom_regressions_tests": [],
    "significant_wilcoxon_improvements": 0,
    "significant_wilcoxon_improvements_tests": [],
    "significant_wilcoxon_regressions": 0,
    "significant_wilcoxon_regressions_tests": [],
    "significant_mannwhitney_improvements": 0,
    "significant_mannwhitney_improvements_tests": [],
    "significant_mannwhitney_regressions": 0,
    "significant_mannwhitney_regressions_tests": [],
    "tests": [
      {
        "test_name": "quick-lint-js-test",
        "is_significant": false,
        "p_value": 1.0,
        "is_pair_significant": false,
        "pair_p_value": 0.9999999999999969,
        "is_binom_significant": false,
        "binom_p_value": 1.0,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999993993187023,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.9374025677927408,
        "relative_improvement": -0.00572082379862688,
        "absolute_improvement_ms": -1.7241379310345417,
        "old_mean_ms": 301.37931034482756,
        "new_mean_ms": 303.1034482758621,
        "old_std_ms": 3.5093120317179856,
        "new_std_ms": 5.413902920037102,
        "effect_size_cohens_d": -0.3779259111081029,
        "old_ci95_ms": [
          300.0444394381776,
          302.71418125147756
        ],
        "new_ci95_ms": [
          301.0441097405405,
          305.16278681118376
        ],
        "old_ci99_ms": [
          299.57859476247495,
          303.18002592718017
        ],
        "new_ci99_ms": [
          300.3254395774784,
          305.88145697424585
        ],
        "new_times": [
          0.3,
          0.31,
          0.3,
          0.31,
          0.31,
          0.3,
          0.31,
          0.3,
          0.3,
          0.31,
          0.3,
          0.3,
          0.29,
          0.3,
          0.3,
          0.3,
          0.31,
          0.31,
          0.3,
          0.31,
          0.3,
          0.3,
          0.31,
          0.3,
          0.3,
          0.3,
          0.31,
          0.3,
          0.3
        ],
        "old_times": [
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.31,
          0.3,
          0.3,
          0.31,
          0.3,
          0.3,
          0.31,
          0.3,
          0.31,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3,
          0.3
        ]
      },
      {
        "test_name": "quick-lint-js-test-cli",
        "is_significant": false,
        "p_value": 0.9999999999998197,
        "is_pair_significant": false,
        "pair_p_value": 0.9999999999993877,
        "is_binom_significant": false,
        "binom_p_value": 0.9999999981373549,
        "is_wilcoxon_significant": false,
        "wilcoxon_p_value": 0.9999978486102682,
        "is_mannwhitney_significant": false,
        "mannwhitney_p_value": 0.16714290224817413,
        "relative_improvement": 0.003816793893129859,
        "absolute_improvement_ms": 0.34482758620690834,
        "old_mean_ms": 90.34482758620689,
        "new_mean_ms": 89.99999999999999,
        "old_std_ms": 1.8569533817705202,
        "new_std_ms": 1.4123431441001795e-14,
        "effect_size_cohens_d": 0.26261286571945386,
        "old_ci95_ms": [
          89.63848029593268,
          91.05117487648111
        ],
        "new_ci95_ms": [
          89.99999999999999,
          89.99999999999999
        ],
        "old_ci99_ms": [
          89.39197846363412,
          91.29767670877966
        ],
        "new_ci99_ms": [
          89.99999999999997,
          90.0
        ],
        "new_times": [
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09
        ],
        "old_times": [
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.09,
          0.1
        ]
      }
    ]
  },
  "logs": {
    "full_log_path": "/logs/full.log",
    "config_log_path": "/logs/config.log",
    "build_log_path": "/logs/build.log",
    "test_log_path": "/logs/test.log",
    "build_success": true,
    "test_success": true
  },
  "raw_timing_data": {
    "warmup_runs": 1,
    "measurement_runs": 30,
    "min_exec_time_improvement": 0.05,
    "min_p_value": 0.05
  }
}